# DO NOT REMOVE the following attributes:
# annotations.codefresh.io/workflow-origin (identifies type of Workflow Template as Promotion Workflow)
# annotations.version (identifies version of Promotion Workflow used)
# annotations.description (identifies intended use of the Promotion Workflow)

apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: service-now-open
  annotations:
    codefresh.io/workflow-origin: promotion
    codefresh.io/promotion-stage: pre-action
    version: 0.0.1
    description: 'promotion workflow template'
spec:
  serviceAccountName: promotion-template
  arguments:
    parameters:
    - name: APP_NAME
  entrypoint: snow-open
  templates:
  - name: snow-open
    dag:
      tasks:
        # - name: argocd-get
        #   template: argocd-get-tmpl
        #   arguments:
        #     parameters:
        #     - name: ARGOCD_SERVER
        #       value: argo-cd-server:80 # or whatever service name you end up using
        #     - name: APP_NAME
        #       value: "{{ workflow.parameters.APP_NAME }}"
        #     - name: TOKEN_SECRET
        #       value: argocd-token
        #     - name: TOKEN_SECRET_KEY
        #       value: token
        - name: create-sn-cr
          # depends: argocd-get
          templateRef:
            name: argo-hub.servicenow.1.3.0
            template: createcr
          arguments:
            parameters:
            - name: TOKEN
              value: cf-api-key-aperture
            - name: CF_RUNTIME
              value: gitops
            - name: SN_INSTANCE
              value: "https://dev201662.service-now.com"
            - name: SN_AUTH
              value: "sn-auth"
            - name: LOG_LEVEL
              value: "debug"
            - name: CR_DATA
              value: >-
                {"short_description": "{{ workflow.parameters.APP_NAME }} deployment",
                "description": "Change for build {{workflow.uid}}.\nThis change was created by the Codefresh GitOps promotion flow",
                "justification": "My app is awesome! Please deploy ASAP",
                "cmdb_ci":"tomcat", "assignment_group":"a715cd759f2002002920bde8132e7018"
                }

        - name: wait
          template: approve
          depends: create-sn-cr

  # Additional templates
  - name: approve
    suspend: {}
      # duration: "72h"
  # - name: argocd-get-tmpl
  #   inputs:
  #     parameters:
  #     - name: ARGOCD_SERVER
  #     - name: APP_NAME
  #     - name: TOKEN_SECRET
  #       default: argocd-token
  #     - name: TOKEN_SECRET_KEY
  #       default: token
  #   outputs:
  #     parameters:
  #     - name: APP_MANIFEST
  #       # globalName: APP_MANIFEST # optional - any global output will reach the post-action as well
  #       valueFrom:
  #         path: /tmp/result.json
  #   script:
  #     name: app-get
  #     image: quay.io/codefreshplugins/argo-hub-workflows-argocd-versions-0.0.1-images-argocd-cli:main
  #     env:
  #     - name: APP_NAME
  #       value: "{{ inputs.parameters.APP_NAME }}"
  #     - name: ARGOCD_SERVER
  #       value: "{{ inputs.parameters.ARGOCD_SERVER }}"
  #     - name: ARGOCD_AUTH_TOKEN
  #       valueFrom:
  #         secretKeyRef:
  #           name: "{{ inputs.parameters.TOKEN_SECRET }}"
  #           key: "{{ inputs.parameters.TOKEN_SECRET_KEY }}"
  #     - name: ARGOCD_OPTS
  #       value: --grpc-web --plaintext
  #     command:
  #     - sh
  #     source: |
  #       argocd app get ${APP_NAME} --output json > /tmp/result.json
